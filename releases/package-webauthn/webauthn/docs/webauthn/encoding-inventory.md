# WebAuthn Encoding Inventory (DEV)

## Scope

This inventory captures every WebAuthn binary field that crosses HTTP JSON between reactapp2 and the `webauthn` Directus endpoint. Canonical rule: **all binary fields are exchanged and stored as base64url (unpadded) strings**.

## Endpoint (extensions/endpoints/webauthn)

- Authentication options (`/login/start`)
  - `options.challenge` – base64url string generated by `generateAuthenticationOptions`, normalized before returning. Source: `src/index.ts` (normalizeAuthenticationOptions).
  - `options.allowCredentials[].id` – base64url string derived from stored `credential_id` (canonicalized). Source: `src/index.ts` (`normalizeStoredCredentials` → `bufToB64Url`).

- Registration options (`/register/start`)
  - `options.challenge` – base64url string. Source: `src/index.ts` (normalizeRegistrationOptions).
  - `options.user.id` – base64url string of the user UUID bytes. Source: `src/index.ts` (normalizeRegistrationOptions/uuidToBuffer → `bufToB64Url`).
  - `options.excludeCredentials[].id` – base64url string of stored credential ids. Source: `src/index.ts` (registration exclude list).

- Incoming assertion/attestation (`/login/finish`, `/register/finish`)
  - Request fields expected as base64url: `credential.id`, `credential.rawId`, `response.clientDataJSON`, `response.authenticatorData`, `response.signature`, `response.attestationObject`, `response.userHandle` (when present). Normalized via shared base64url helpers. Source: `src/index.ts` (normalizeAssertionCredential, deriveCredentialId, base64url utils).
  - Stored lookup key: `credential_id` is normalized to base64url (unpadded) before comparison and updates. Source: `src/index.ts` (normalizeStoredCredentials/deriveCredentialId path).
  - Public key (`public_key`) decoded using the canonical helper that accepts base64/base64url but normalizes to base64url before verification. Source: `src/index.ts` (decodePublicKeyToBuffer).

## React client (reactapp2)

- Adapter: `src/webauthn/webauthnCodec.ts`
  - `credentialToJSON` encodes `id`, `rawId`, `response.clientDataJSON`, `response.authenticatorData`, `response.signature`, `response.userHandle`, `response.attestationObject`, `response.transports` to base64url (unpadded) before POST.
  - `toPublicKeyCredentialCreationOptions` / `toPublicKeyCredentialRequestOptions` decode `challenge`, `user.id`, and `allowCredentials`/`excludeCredentials` ids from base64url into `Uint8Array` for `navigator.credentials.*`.
  - `deriveAaguidFromAttestation` (UI only) parses `attestationObject` CBOR to present AAGUID without changing the server payload.

## Storage (Directus `webauthn_credentials`)

- `credential_id` is stored and compared only as normalized base64url (unpadded).
- `public_key` is stored as base64/base64url bytes; verification uses canonical decode and does not re-encode for storage.
- `sign_count` is numeric; incremented after successful authentication.

## Field summary

| Field | Direction | Canonical format |
| --- | --- | --- |
| challenge (start options) | server → client | base64url (unpadded) |
| user.id (start options) | server → client | base64url (unpadded) |
| allowCredentials[].id / excludeCredentials[].id | server → client | base64url (unpadded) |
| credential.id / rawId | client → server | base64url (unpadded) |
| response.clientDataJSON | client → server | base64url (unpadded) |
| response.authenticatorData | client → server | base64url (unpadded) |
| response.signature | client → server | base64url (unpadded) |
| response.userHandle | client → server | base64url (unpadded) |
| response.attestationObject | client → server (registration) | base64url (unpadded) |
| stored credential_id | DB | base64url (unpadded) |
| stored public_key | DB | base64/base64url bytes; normalized to buffer for verification |
